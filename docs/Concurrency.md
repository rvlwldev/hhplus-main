# DB Lock VS Redis VS Kafka

> 기존의 디비락을 유지할지, Redis, Kafka를 도입할지...  
> 고민하는 과정에서 Kafka는 비교적 어느정도 구현난이도가 높다는 것을 알았습니다.  
> 또한 운영의 복잡성이 높기에 차근차근 밟아 나가기로 했습니다.

## DB락(비관적락) 배제

데이터베이스에게 락을 위임하는 것은 자원에 대해서 데이터 일관성을 아주 강하게 유지할 수 있지만,  
멘토링때 말씀해주신 것처럼 다양한 상황으로 인해 언제든지 데드락이 발생할 수 있다는 것을 알았습니다.  
결국 누군가가 인위적으로 해당 락을 풀어줘야하며 이는 전체 성능 저하 뿐만 아니라 뻗을 수도(?) 있는 위험을 가지고 있습니다.

~~확장성/운영성을 기르기 위해 DB가 아닌 다른 분리된 시스템을 사용하기로 했습니다.~~

-----

## Redis VS Kafka
> 두 시스템의 차이를 여러 방면으로 찾아봤습니다.
> 
### 동시성을 제어하는 방법
- Redis
> 레디스는 인메모리 방식으로 락의 제어가 빠릅니다.  
> 키를 기준으로 락을 제어하며 데이터 자체에 강하게 일관성을 보장합니다.  

단순한 방식의 락 제어 방식을 사용하면서 빠른 성능을 제공하지만,  
처리량이 높아지면 높아질 수록 리소스의 한계에 부딪힐 수 있습니다.  
그래서 캐싱, 분산락 등 빠른 접근과 실시간 트랜젝션 단위의  
데이터의 일관성이 중요시 되는 도메인에 적합하다는 생각이 들었습니다.

- Kafka
> 카프카는 이벤트 기반으로 더 현대적인 방법을 사용하며  
> 파티션별 비동기처리로 서버 어플리케이션과의 결합을 느슨하게 유지합니다.

위 레디스가 일관성을 강하게 가져가는 구조라면,  
카프카는 데이터 자체의 내구성에 더 뛰어난 방식을 사용합니다.  
또한 각 파티션은 싱글스레드로 동작하는 구조로 경합 상태에 대한 부담을 덜어줍니다.  
그래서 즉각적인 요청 처리가 아닌,  
로그 수집이나 분석, 데이터 파이프라인 구축등에 많이 사용됩니다.

-----

### 구현난이도
- Redis

설치와 운영이 간단하고 과거 잠깐이나마 사용한 경험이 있습니다.  
또한 설정이나 락의 활용도 단순한 편입니다.

- Kafak

Kafka의 경우 브로커, 데이터 복제 설정, 파티셔닝 전략 등 많은 설정이 있으며  
다루는 사람에 따라 인적 오류로 인해 안정성을 해치기 더 쉬운 구조를 가지고 있습니다.  
기본적으로 여러 서버 어플리케이션에서 운영적인 인프라에 대한 이해와 추가적인 관리가 필요하다고 느꼈습니다.

-----

### 기존의 어플리케이션과의 결합 편의성
- Redis

태생부터 인메모리로 동작하기에, 캐시서버로 많이 활용되는 만큼 보조적인 역할이 큽니다.   
기존의 시스텀에서도 REST 방식의 데이터 송수신 형태에도 쉽게 결합할 수 있습니다.  
휘발성이라 신뢰성은 낮지만 Pub/Sub 기능도 지원하기에 추후 활용도가 올라갑니다.    
또한 추가적인 모니터링이나 관리에 부담이 적습니다.  

- Kafka

여러 노드로 나뉘어진 클러스터 기반으로 운영되면서 비동기적으로 동작하기에  
기존의 동기적인 방식과 결합하기에는 고려 사항이 많습니다.  
최악의 경우 전체 아키텍쳐에 대한 재설계가 필요할 수도 있습니다.  
이는 낮은 연차의 개발자에게 부담을 가중시킬 수 있다고 생각합니다.  
하지만 At Least Once, At Most Once, Exactly Once 와 같은 옵션 지원과  
각 파티션에 데이터를 분산함으로써 대규모 트래픽에도 안정적으로 운영할 수 있는 장점이 있습니다. 

-----

## 결론 - Redis

### 1. 급할수록 돌아가라
멘토링때 JPA를 사용하며 연관관계를 최소한으로 사용한다는 케이스를 듣고  
저도 시도해봤다가 설계 미스로 인해 구현이 계속 복잡해지고 처음부터 다시 구현한 경험이 있어  
단계적인 향상이 중요하다는 것을 느꼈습니다.

### 2. 시간압박
레디스는 아주 잠깐이지만 기본적인 자료구조 정도는 가볍게 알 만큼의 경험이 있습니다.  
그에 비해 카프카는 경험이 전혀 없을 뿐더러 기본적인 내용 조차 처음 접해보기에,  
주 단위의 일정에서는 무리라고 생각했습니다.

### 3. 단계적 학습과 응용
난이도가 낮은 시스템부터 접근해보면서 장단점에 대해 충분히 학습이 필요하다고 생각했습니다.  
또한 상황에 따라 카프카가 더 어렵고 많은 기능과 옵션을 제공한다 하더라도,  
캐시와 같은 즉각적인 반응이 필요한 상황에서는 레디스가 더욱 적합하기 때문에  
레디스 또한, 꼭 알아둬야하는 지식 중 하나라고 생각합니다.

### 4. 요구사항
추후의 요구사항은 아직 파악되지 않지만, 현재는 동시성 제어가 가장 큰 요구사항이기에,  
레디스의 분산락 기능으로도 충분하다고 생각합니다.  
이 후에도 카프카가 적합한 요구사항이 생긴다고 해도,  
스프링, 레디스, 카프카는 적절하게 독립적으로 확장, 결합이 가능한 구조이기에  
현재 레디스를 선택하는것이 리스크를 줄이고 학습 효율성과 더불어  
실무에서의 실제 개발 효율성도 높일 수 있는 방향이라고 생각했습니다.




